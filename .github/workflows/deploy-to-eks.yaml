name: Deploy Inference to EKS

on:
  push:
    branches:
      - main

permissions:
  id-token: write      # ← REQUIRED for OIDC to work!
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # ── Login to AWS (using OIDC – most secure & recommended) ───────────────
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::703176829610:role/github-ci-cd-inference
        aws-region: ap-south-1

    # ── Login to ECR ────────────────────────────────────────────────────────
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    # ── Build & push Docker image ───────────────────────────────────────────
    - name: Build, tag, and push image to ECR
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        ECR_REPOSITORY: inference-yolov8n
        IMAGE_TAG: ${{ github.sha }}
      run: |
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

    # ── Update kubeconfig for EKS ───────────────────────────────────────────
    - name: Update kubeconfig
      run: aws eks update-kubeconfig --name video-inference --region ap-south-1

    # ── Deploy to EKS (update image tag) ────────────────────────────────────
    - name: Deploy to EKS
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        # Replace image in deployment.yaml
        sed -i "s|703176829610.dkr.ecr.ap-south-1.amazonaws.com/inference-yolov8n:latest|$ECR_REGISTRY/inference-yolov8n:$IMAGE_TAG|g" inference-deployment.yaml
        
        kubectl apply -f inference-deployment.yaml
        kubectl rollout status deployment/inference-yolov8n --timeout=300s